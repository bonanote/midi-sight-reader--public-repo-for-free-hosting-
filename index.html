<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>MIDI Sight Reader – Custom Edition v4.0 (Fixed & Stable CDN)</title>
<script src="https://cdn.jsdelivr.net/npm/vexflow@3.0.9/build/vexflow-min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&family=Exo+2:wght@400;700&display=swap" rel="stylesheet">
<style>
    :root {
        --body-bg: #0a0e14;
        --rack-gradient: linear-gradient(180deg, #4b6cb7 0%, #2c4575 15%, #182848 100%);
        --panel-bg: rgba(10, 20, 40, 0.6);
        --neon-cyan: #00f2ff;
        --neon-green: #00ff99;
        --neon-red: #ff0055;
        --radius-main: 20px;
        --radius-sm: 12px;
    }

    body {
        font-family: 'Exo 2', sans-serif;
        background: var(--body-bg);
        background-image: radial-gradient(circle at 50% 0%, #1a2a40 0%, #0a0e14 80%);
        color: #cceeff;
        margin: 0;
        padding: 10px; 
        display: flex;
        flex-direction: column;
        align-items: center;
        min-height: 100vh;
    }

    .rack-unit {
        width: 100%;
        max-width: 1150px;
        background: var(--rack-gradient);
        border-radius: 20px;
        box-shadow: 0 0 0 2px #3a5a8a, 0 20px 60px rgba(0,0,0,0.9);
        padding: 15px; 
        position: relative;
        border: 1px solid #162236;
    }

    h1 {
        font-family: 'Orbitron', sans-serif;
        text-transform: uppercase;
        letter-spacing: 3px;
        color: #fff;
        text-shadow: 1px 1px 0px rgba(0,0,0,0.5);
        margin: 0 0 10px 0;
        font-size: 24px;
        border-bottom: 2px solid rgba(0, 242, 255, 0.3);
        padding-bottom: 5px;
        display: flex;
        justify-content: space-between;
        align-items: baseline;
    }

    #stats-panel {
        background: rgba(0, 10, 20, 0.8);
        border: 1px solid #4fa3d1;
        border-radius: var(--radius-main);
        padding: 10px 20px;
        margin-bottom: 10px; 
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: inset 0 0 20px rgba(0, 242, 255, 0.1);
    }
    
    #status { color: #8ecae6; font-size: 14px; font-weight: 700; }
    
    #stats, #timer { 
        color: var(--neon-cyan); 
        font-family: 'Orbitron', sans-serif; 
        font-size: 18px;
        font-weight: 700;
        letter-spacing: 1px;
        margin-left: 20px;
    }

    .range-controls-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(110px, 1fr));
        gap: 10px;
        padding: 10px;
        background: var(--panel-bg);
        border-radius: var(--radius-main);
        border: 1px solid rgba(255,255,255,0.05);
        margin-bottom: 10px; 
        box-shadow: inset 2px 2px 5px rgba(0,0,0,0.5);
    }

    /* Span 2 columns for the text input to give it room */
    .wide-input { grid-column: span 2; }

    .control-group { display: flex; flex-direction: column; align-items: center; }
    label { font-size: 10px; text-transform: uppercase; color: #aabdd1; margin-bottom: 4px; font-weight: 700; }

    input[type="number"], select, input[type="text"] {
        background: #0b1624;
        color: var(--neon-cyan);
        border: 1px solid #3a5a8a;
        padding: 6px;
        font-family: 'Orbitron', sans-serif;
        font-size: 14px;
        width: 100%;
        text-align: center;
        border-radius: 15px;
        outline: none;
    }
    input[type="text"] { text-align: left; padding-left: 10px; font-family: 'Exo 2', sans-serif; font-weight: 600; color: #fff;}

    input[type="checkbox"] {
        appearance: none;
        width: 40px;
        height: 20px;
        background: #1b2b40;
        border-radius: 12px;
        position: relative;
        cursor: pointer;
        border: 1px solid #3a5a8a;
    }
    input[type="checkbox"]::after {
        content: ''; position: absolute; top: 2px; left: 2px;
        width: 14px; height: 14px; border-radius: 50%;
        background: linear-gradient(180deg, #b0c4de 0%, #7a92b1 100%);
        transition: 0.3s;
    }
    input[type="checkbox"]:checked { background: rgba(0, 242, 255, 0.2); border-color: var(--neon-cyan); }
    input[type="checkbox"]:checked::after { left: 22px; background: var(--neon-cyan); box-shadow: 0 0 5px var(--neon-cyan); }

    #staffContainer {
        margin: 5px 0 15px 0;
        background: linear-gradient(180deg, #e0f7ff 0%, #cceeff 100%);
        border: 6px solid #1b2b40;
        border-radius: 20px;
        box-shadow: inset 0 0 30px rgba(0, 150, 255, 0.2), 0 10px 30px rgba(0,0,0,0.6);
        overflow-x: hidden;
        /* INCREASED HEIGHT TO 240px to remove need for scrollbar */
        height: 240px; 
        position: relative;
        scroll-behavior: smooth;
    }

    #noteStripe { height: 35px; position: relative; }

    #noteNameDisplay {
        font-family: 'Orbitron', sans-serif;
        font-size: 20px;
        font-weight: bold;
        color: #000;
        position: absolute;
        top: 8px;
        z-index: 10;
        background: var(--neon-cyan);
        padding: 2px 12px;
        border-radius: 15px;
        display: none;
        border: 2px solid #fff;
    }
    
    .correct-flash { animation: flashGreen 0.3s ease-out; }
    .wrong-flash { animation: flashRed 0.3s ease-out; }
    @keyframes flashGreen { 0% { background-color: rgba(0, 255, 153, 0.6); } 100% { background-color: transparent; } }
    @keyframes flashRed { 0% { background-color: rgba(255, 0, 85, 0.6); } 100% { background-color: transparent; } }

    .button-row { display: flex; justify-content: center; gap: 20px; margin: 10px; }

    button {
        padding: 10px 24px;
        border: none;
        border-radius: 30px;
        cursor: pointer;
        font-family: 'Orbitron', sans-serif;
        font-weight: 600;
        font-size: 13px;
        text-transform: uppercase;
        letter-spacing: 1px;
        color: #fff;
        background: linear-gradient(180deg, #3a5a8a 0%, #162236 100%);
        box-shadow: 0 5px 10px rgba(0,0,0,0.4), inset 0 1px 0 rgba(255,255,255,0.2);
    }
    button:hover {
        background: linear-gradient(180deg, #4b7bc7 0%, #2c4575 100%);
        color: var(--neon-cyan);
    }

    #ledger, #sessionDisplay {
        margin: 5px 20px;
        padding: 10px;
        background: rgba(0,0,0,0.4);
        border: 1px solid #3a5a8a;
        border-radius: var(--radius-sm);
        color: #8ecae6;
        font-family: 'Exo 2', sans-serif;
        font-weight: 600;
        font-size: 14px;
        line-height: 1.4;
    }
    
    .wrong-entry { color: var(--neon-red); font-weight: bold; }
    .stat-item {
        display: inline-block;
        background: #162236;
        border: 1px solid #3a5a8a;
        color: var(--neon-cyan);
        margin: 3px;
        padding: 4px 10px;
        border-radius: 10px;
        font-size: 14px;
    }

    #midiSelector {
        background: rgba(15, 25, 40, 0.98) !important;
        border: 2px solid var(--neon-cyan) !important;
        border-radius: 20px !important;
        color: #fff !important;
        box-shadow: 0 0 20px rgba(0, 242, 255, 0.3);
    }
    #midiSelect { width: 100%; margin-top: 10px; background: #000; max-width: none; }
    #useSelectedBtn { background: var(--neon-cyan); color: #000; width: 100%; margin-top: 15px; }
</style>
</head>
<body>

<div class="rack-unit">
    <h1>
        MIDI SIGHT READER 
        <span style="font-size:12px; color:var(--neon-cyan); letter-spacing: 1px; border: 1px solid var(--neon-cyan); padding: 2px 8px; border-radius: 10px;">v4.0 CUSTOM</span>
    </h1>

    <div id="stats-panel">
        <div id="status">SYSTEM: STANDBY</div>
        <div style="text-align:right;">
            <div id="stats">NOTES: 0 | ERRORS: 0 (0%)</div>
            <div id="timer">AVG TIME: 0.00s</div>
        </div>
    </div>

    <div class="range-controls-row">
        <div class="control-group wide-input">
            <label>Custom Set (e.g. C4, F#, Bb3)</label>
            <input type="text" id="customNotes" placeholder="Leave empty for random...">
        </div>
        
        <div class="control-group"><label>Min Pitch</label><input type="number" id="minPitch" value="53"></div>
        <div class="control-group"><label>Max Pitch</label><input type="number" id="maxPitch" value="88"></div>
        <div class="control-group"><label>Set Size</label><input type="number" id="setSize" value="20" min="6" max="36"></div>
        <div class="control-group"><label>Max Jump</label><input type="number" id="maxJump" value="5" min="1" max="18"></div>
        <div class="control-group"><label>BPM</label><input type="number" id="bpm" value="60" min="20" max="300"></div>
        <div class="control-group"><label>Delay (ms)</label><input type="number" id="nextSetDelay" value="200" step="100" min="0"></div>
    </div>

    <div class="range-controls-row">
        <div class="control-group"><label>Scale</label>
            <select id="mode">
                <option value="chromatic" selected>Chromatic</option>
                <option value="g-major">G Major</option>
            </select>
        </div>
        <div class="control-group"><label>Waveform</label>
            <select id="waveform">
                <option>sine</option><option>square</option><option>sawtooth</option><option>triangle</option>
            </select>
        </div>
        <div class="control-group"><label>Sharps</label><input type="checkbox" id="useSharps" checked></div>
        <div class="control-group"><label>Flats</label><input type="checkbox" id="useFlats" checked></div>
        <div class="control-group"><label>Acc Only</label><input type="checkbox" id="onlyAccidentals"></div>
        <div class="control-group"><label>Note Name</label><input type="checkbox" id="showNoteName" checked></div>
        <div class="control-group"><label>Audio</label><input type="checkbox" id="enableSound"></div>
        <div class="control-group"><label>Metronome</label><input type="checkbox" id="enableClick"></div>
    </div>

    <div id="midiSelector" style="display:none;margin:15px;padding:20px;">
        <p style="margin:0 0 10px 0; font-size:16px; font-weight:bold; text-align:center;">SELECT MIDI INTERFACE</p>
        <select id="midiSelect"></select>
        <button id="useSelectedBtn">ACTIVATE CONNECTION</button>
    </div>

    <div id="staffContainer">
        <div id="noteStripe"><div id="noteNameDisplay"></div></div>
        <div id="staff"></div>
    </div>

    <div class="button-row">
        <button id="connectBtn">Initialize MIDI</button>
        <button id="showSessionStats">View Logs</button>
        <button id="resetSessionBtn">System Reset</button>
    </div>

    <div id="ledger"></div>
    <div id="sessionDisplay"></div>
</div>

<script>
let VF, audioCtx, midiAccess, inputPort, isRunning=false;
let currentSet=[], currentIndex=0, lastPitch=null;
let wrongCounts=new Map(), totalWrongsPerNote=new Map();
let noteDisplays=new Map(), noteCorrects=new Map();
let totalCorrect=0, totalWrongs=0, noteCount=0, totalTime=0;
let currentStartTime, pendingAdvance=false;
let noteTimeoutTimer = null;
let missedIndices = new Set(); 
let customNoteList = []; // Stores the parsed custom rules

// Settings
let minPitch=53, maxPitch=88, setSize=20, maxJump=5;
let nextSetDelay=200; 
let bpm = 60; 
let useSharps=true, useFlats=true, onlyAccidentals=false;
let showNoteName=true, enableSound=false, enableClick=false, waveform='sine', mode='chromatic';

const BIAS_FACTOR=3;
const IN_SCALE_BONUS=5;
const scaleSemis=[0,2,4,6,7,9,11];
const NOTE_WIDTH_PX = 40; 

const gMajorSpelling={
    0:{b:'c',a:null,d:'C'}, 1:{b:'c',a:'#',d:'C#'}, 2:{b:'d',a:null,d:'D'},
    3:{b:'d',a:'#',d:'D#'}, 4:{b:'e',a:null,d:'E'}, 5:{b:'f',a:'n',d:'F'},
    6:{b:'f',a:null,d:'F#'},7:{b:'g',a:null,d:'G'}, 8:{b:'g',a:'#',d:'G#'},
    9:{b:'a',a:null,d:'A'},10:{b:'a',a:'#',d:'A#'},11:{b:'b',a:null,d:'B'}
};
const naturalSemis=[0,2,4,5,7,9,11];
const accidentalSemis=[1,3,6,8,10];
const blackKeys={
    1:{sharp:{b:'c',a:'#',d:'c#'},flat:{b:'d',a:'b',d:'db'}},
    3:{sharp:{b:'d',a:'#',d:'d#'},flat:{b:'e',a:'b',d:'eb'}},
    6:{sharp:{b:'f',a:'#',d:'f#'},flat:{b:'g',a:'b',d:'gb'}},
    8:{sharp:{b:'g',a:'#',d:'g#'},flat:{b:'a',a:'b',d:'ab'}},
    10:{sharp:{b:'a',a:'#',d:'a#'},flat:{b:'b',a:'b',d:'bb'}}
};

// Map note names to semi-tone index (0-11)
const noteNameMap = {
    'c':0, 'c#':1, 'db':1, 'd':2, 'd#':3, 'eb':3, 'e':4, 'f':5, 'f#':6, 'gb':6, 
    'g':7, 'g#':8, 'ab':8, 'a':9, 'a#':10, 'bb':10, 'b':11
};

function weightedRandom(items,weights){
    let t=weights.reduce((a,b)=>a+b,0), r=Math.random()*t;
    for(let i=0;i<items.length;i++){ r-=weights[i]; if(r<=0) return items[i]; }
    return items[items.length-1];
}

function getNoteInfo(pitch){
    const oct=Math.floor(pitch/12)-1, semi=pitch%12;
    let base, acc=null, disp, key;
    if(mode==='g-major'){
        const s=gMajorSpelling[semi];
        base=s.b; acc=s.a; disp=s.d+'/'+oct;
    }else{
        if(naturalSemis.includes(semi)){
            base=['c','d','e','f','g','a','b'][naturalSemis.indexOf(semi)];
            disp=base.toUpperCase()+'/'+oct;
        }else{
            const choice=(useSharps&&useFlats)?(Math.random()<0.5?'sharp':'flat'):(useSharps?'sharp':'flat');
            const sel=blackKeys[semi][choice];
            base=sel.b; acc=sel.a; 
            const accChar = sel.a === 'b' ? 'b' : '#';
            disp = sel.b.toUpperCase() + accChar + '/' + oct;
        }
    }
    key=base+'/'+oct;
    return {baseKey:key, accidental:acc, displayName:disp};
}

function scrollToActiveNote() {
    const container = document.getElementById('staffContainer');
    if (!container) return;
    const containerW = container.clientWidth;
    const targetX = (currentIndex * NOTE_WIDTH_PX) + 60 - (containerW / 2);
    container.scrollTo({ left: Math.max(0, targetX), behavior: 'smooth' });
}

function drawSet(temp
